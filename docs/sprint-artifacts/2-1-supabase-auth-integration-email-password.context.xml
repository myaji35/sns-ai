<?xml version="1.0" encoding="UTF-8"?>
<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>2.1</storyId>
    <title>Supabase Auth 통합 (이메일/비밀번호)</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-15</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/2-1-supabase-auth-integration-email-password.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>신규 사용자</asA>
    <iWant>이메일과 비밀번호로 계정을 생성할 수 있어</iWant>
    <soThat>ContentFlow AI를 사용할 수 있다</soThat>
    <tasks>
      <task n="1">회원가입 페이지 UI 개발 - Shadcn/ui 컴포넌트로 /signup/page.tsx 생성, 비밀번호 강도 표시기 컴포넌트 개발</task>
      <task n="2">폼 검증 스키마 작성 - Zod 스키마 생성 (lib/schemas/auth.schema.ts), 에러 메시지 한글화</task>
      <task n="3">회원가입 폼 컴포넌트 개발 - SignUpForm.tsx 컴포넌트, React Hook Form 통합, 실시간 유효성 검사</task>
      <task n="4">Supabase Auth API 통합 - lib/api/auth-api.ts 파일 생성, signup() 함수, 에러 처리</task>
      <task n="5">세션 관리 및 리다이렉트 - 가입 후 자동 로그인 처리, Zustand authStore 통합, /dashboard 리다이렉트</task>
      <task n="6">테스트 코드 작성 - 유니트 테스트, 통합 테스트, E2E 테스트</task>
      <task n="7">에러 처리 및 사용자 피드백 - Supabase 에러 처리, 사용자 친화적 오류 메시지</task>
      <task n="8">reCAPTCHA v3 통합 (선택사항) - reCAPTCHA 설정, 봇 점수 검증, 서버 검증</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC1">
      <title>Supabase Auth에 사용자 생성</title>
      <items>
        <item>회원가입 API 호출 시 Supabase Auth에 새 사용자 생성</item>
        <item>사용자 이메일 및 비밀번호 저장</item>
        <item>public.profiles 테이블에 자동으로 사용자 레코드 생성</item>
      </items>
    </criterion>
    <criterion id="AC2">
      <title>비밀번호 정책 강제</title>
      <items>
        <item>최소 8자 이상</item>
        <item>대문자 1개 이상 포함</item>
        <item>숫자 1개 이상 포함</item>
        <item>특수문자 1개 이상 포함 (!@#$%^&*)</item>
        <item>약한 비밀번호 입력 시 명확한 오류 메시지 표시</item>
      </items>
    </criterion>
    <criterion id="AC3">
      <title>이메일 검증</title>
      <items>
        <item>RFC 5322 표준 준수</item>
        <item>유효하지 않은 이메일 형식 거부</item>
        <item>이메일 중복 여부 확인 (기존 사용자 존재 시 오류)</item>
        <item>중복 이메일 시 "이미 가입된 이메일입니다" 오류 메시지</item>
      </items>
    </criterion>
    <criterion id="AC4">
      <title>자동 로그인 및 리다이렉트</title>
      <items>
        <item>가입 완료 후 자동으로 로그인 (세션 생성)</item>
        <item>/dashboard로 자동 리다이렉트</item>
        <item>JWT 토큰이 localStorage/cookie에 저장</item>
      </items>
    </criterion>
    <criterion id="AC5">
      <title>이메일 인증</title>
      <items>
        <item>가입 완료 시 확인 이메일 발송 (Supabase 기본 기능)</item>
        <item>이메일에는 확인 링크 포함</item>
        <item>사용자가 링크 클릭하여 이메일 검증</item>
      </items>
    </criterion>
    <criterion id="AC6">
      <title>UI/UX</title>
      <items>
        <item>회원가입 페이지 (/signup) 구현</item>
        <item>실시간 폼 유효성 검사 피드백</item>
        <item>비밀번호 강도 표시기 (약함/보통/강함)</item>
        <item>모바일 반응형 (44x44px 터치 타겟)</item>
        <item>로딩 상태 표시 (제출 중)</item>
        <item>오류 메시지 친절하고 명확</item>
      </items>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document</title>
        <section>User Authentication & Account Management (Epic 2)</section>
        <snippet>사용자가 이메일과 비밀번호로 계정을 생성할 수 있으며, Supabase Auth를 통한 안전한 인증 구현. 비밀번호 정책: 8자 이상, 대문자, 숫자, 특수문자 필수. RFC 5322 이메일 검증 및 중복 방지.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-2.md</path>
        <title>Epic 2: Technical Specification</title>
        <section>Story 2.1: Supabase Auth 통합 (이메일/비밀번호)</section>
        <snippet>Frontend: React Hook Form + Zod 검증, Backend: Supabase signUp() API, UI: Shadcn/ui 컴포넌트. 비밀번호 강도 표시기 (3단계), 실시간 유효성 검사, reCAPTCHA v3 (선택사항), 모바일 반응형.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Technical Architecture Document</title>
        <section>Authentication Flow & Component Architecture</section>
        <snippet>Next.js 15 Frontend (App Router) → Supabase Auth API → PostgreSQL Database. Component structure: /auth/(auth)/signup/page.tsx, components/auth/SignUpForm.tsx, components/auth/PasswordStrengthMeter.tsx, lib/schemas/auth.schema.ts, lib/api/auth-api.ts</snippet>
      </doc>
      <doc>
        <path>docs/ux-design-specification.md</path>
        <title>UX Design Specification</title>
        <section>Design System & Auth Pages</section>
        <snippet>Shadcn/ui (Radix UI 기반), Tailwind CSS, Pretendard 한글 폰트. Trust Blue (#0EA5E9) 컬러 테마. 핵심 UX 원칙: Zero Learning Curve, 실시간 피드백, WYSIWYG 편집, 명확한 상태 표시.</snippet>
      </doc>
    </docs>

    <code>
      <artifact>
        <path>apps/web/src/lib/supabase/client.ts</path>
        <kind>module</kind>
        <symbol>createClient()</symbol>
        <lines>1-8</lines>
        <reason>기존 Supabase 클라이언트 생성 함수. 회원가입 API에서 signUp() 호출 시 사용할 클라이언트</reason>
      </artifact>
      <artifact>
        <path>apps/web/package.json</path>
        <kind>config</kind>
        <symbol>dependencies</symbol>
        <reason>React Hook Form (7.66.0), Zod (4.1.12), @supabase/supabase-js (2.81.1) 등 필요한 의존성 확인. @hookform/resolvers (5.2.2) 필요 여부 검토</reason>
      </artifact>
      <artifact>
        <path>apps/web/tsconfig.json</path>
        <kind>config</kind>
        <symbol>compilerOptions</symbol>
        <reason>TypeScript strict mode, path aliases (@/*) 설정 확인. lib/schemas, lib/api, components/auth 경로 설정</reason>
      </artifact>
      <artifact>
        <path>supabase/migrations</path>
        <kind>database</kind>
        <symbol>public.profiles, auth.users</symbol>
        <reason>이미 생성된 profiles 테이블과 Supabase auth.users 스키마. signUp() 시 자동으로 profiles 레코드 생성되는 trigger 확인</reason>
      </artifact>
    </code>

    <dependencies>
      <nodejs>
        <package name="react-hook-form" version="7.66.0">폼 상태 관리 및 검증</package>
        <package name="@hookform/resolvers" version="5.2.2">React Hook Form과 Zod 연결</package>
        <package name="zod" version="4.1.12">스키마 검증 라이브러리</package>
        <package name="@supabase/supabase-js" version="2.81.1">Supabase 클라이언트 SDK</package>
        <package name="@supabase/ssr" version="0.7.0">Supabase SSR 통합</package>
        <package name="next" version="15.0.3">Next.js App Router</package>
        <package name="typescript" version="5.6.0">TypeScript strict mode 컴파일</package>
      </nodejs>
    </dependencies>
  </artifacts>

  <constraints>
    <item>React Hook Form과 Zod 조합으로 폼 검증 구현 (성능 최적화)</item>
    <item>Shadcn/ui 컴포넌트 사용으로 접근성 보장 (Radix UI 기반 WCAG AA)</item>
    <item>비밀번호 정책: 최소 8자, 대문자, 숫자, 특수문자 필수 (문자 1개 이상 포함 아님 - 영문자만)</item>
    <item>RFC 5322 이메일 검증으로 표준 준수</item>
    <item>Supabase Auth에서 제공하는 signUp() API 사용 (직접 DB insert 금지)</item>
    <item>세션 관리는 Supabase의 토큰 기반 방식 (httpOnly cookie 권장)</item>
    <item>에러 메시지는 항상 한글로 작성 (사용자 친화적)</item>
    <item>모바일 반응형: 터치 타겟 최소 44x44px</item>
    <item>TypeScript strict mode 준수</item>
    <item>ESLint 규칙 준수, Prettier 자동 포매팅</item>
  </constraints>

  <interfaces>
    <interface>
      <name>signup()</name>
      <kind>function signature</kind>
      <signature>signup(email: string, password: string): Promise&lt;{ user: User; session: Session } | { error: AuthError }&gt;</signature>
      <path>lib/api/auth-api.ts (생성 예정)</path>
    </interface>
    <interface>
      <name>validatePassword()</name>
      <kind>function signature</kind>
      <signature>validatePassword(password: string): { isValid: boolean; strength: 'weak' | 'medium' | 'strong'; messages: string[] }</signature>
      <path>components/auth/PasswordStrengthMeter.tsx (생성 예정)</path>
    </interface>
    <interface>
      <name>SignUpForm</name>
      <kind>React component</kind>
      <signature>export function SignUpForm(): JSX.Element</signature>
      <path>components/auth/SignUpForm.tsx (생성 예정)</path>
    </interface>
    <interface>
      <name>Supabase Auth API</name>
      <kind>REST API</kind>
      <signature>POST /auth/v1/signup { email, password } → { user, session }</signature>
      <path>Supabase Platform (external)</path>
    </interface>
    <interface>
      <name>Zod Schema</name>
      <kind>schema definition</kind>
      <signature>z.object({ email: z.string().email(), password: z.string().min(8)... })</signature>
      <path>lib/schemas/auth.schema.ts (생성 예정)</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      프로젝트에서 사용하는 테스트 프레임워크: Jest (또는 Vitest). 테스팅 위치: __tests__ 디렉토리. 테스트 패턴: Unit tests (스키마 검증, 함수 로직), Integration tests (API 호출), E2E tests (Playwright - 전체 흐름). 명명 규칙: *.test.ts 또는 *.spec.ts. 커버리지 목표: 80% 이상.
    </standards>
    <locations>
      <glob>apps/web/src/__tests__/**/*.test.ts</glob>
      <glob>apps/web/src/__tests__/**/*.spec.ts</glob>
      <directory>apps/web/__tests__/</directory>
      <note>테스트 파일 구조: 소스와 동일한 경로에 __tests__ 폴더 또는 별도의 __tests__ 디렉토리</note>
    </locations>
    <ideas>
      <idea criterion="AC1">signup() 함수가 유효한 이메일/비밀번호로 Supabase Auth에 사용자를 생성하는지 테스트</idea>
      <idea criterion="AC2">비밀번호 정책 검증: 7자 거부, 소문자만 거부, 숫자 없음 거부, 특수문자 없음 거부, 8자 이상 + 대문자 + 숫자 + 특수문자 통과</idea>
      <idea criterion="AC3">이메일 검증: RFC 5322 형식 확인, 중복 이메일 거부 테스트, "이미 가입된 이메일" 오류 메시지 확인</idea>
      <idea criterion="AC4">가입 후 자동 로그인: authStore에 사용자 정보 저장, /dashboard 리다이렉트 확인, JWT 토큰 localStorage/cookie 저장 확인</idea>
      <idea criterion="AC5">이메일 인증: signup() 성공 후 이메일 발송 감지 (모의 서버 또는 Supabase webhook 테스트)</idea>
      <idea criterion="AC6">UI 렌더링: 실시간 오류 메시지 표시, 비밀번호 강도 표시기 단계 표시, 모바일 반응형 검사 (44x44px 터치 타겟), 로딩 상태 표시</idea>
      <idea type="e2e">완전한 회원가입 흐름: 페이지 접속 → 폼 입력 → 제출 → 대시보드 리다이렉트</idea>
      <idea type="e2e">에러 흐름: 약한 비밀번호 입력 → 오류 메시지 표시 → 수정 후 재시도</idea>
    </ideas>
  </tests>
</story-context>
