<?xml version="1.0" encoding="UTF-8"?>
<story-context id="story-2.5-context" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>2.5</storyId>
    <title>프로필 등록 및 온보딩</title>
    <storyKey>2-5-profile-registration-onboarding</storyKey>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-15</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/2-5-profile-registration-onboarding.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>신규 사용자</asA>
    <iWant>회원가입 후 프로필 정보(이름, 소개, 프로필사진)를 등록하고</iWant>
    <soThat>개인화된 경험을 할 수 있다</soThat>
    <tasks>
      <task n="1">온보딩 페이지 레이아웃 생성 (/onboarding/page.tsx)</task>
      <task n="2">온보딩 폼 상태 관리 (Zustand onboardingStore 생성)</task>
      <task n="3">Step 1 - 기본 정보 컴포넌트 (OnboardingStep1.tsx)</task>
      <task n="4">Step 2 - 소개 정보 컴포넌트 (OnboardingStep2.tsx)</task>
      <task n="5">Step 3 - 프로필 사진 업로드 컴포넌트 (OnboardingStep3.tsx)</task>
      <task n="6">이미지 업로드 유틸리티 (lib/utils/image.ts)</task>
      <task n="7">프로필 API 함수 (lib/api/profile-api.ts)</task>
      <task n="8">온보딩 완료 로직 및 리다이렉트</task>
      <task n="9">테스트 코드 작성</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC1">
      <title>온보딩 페이지</title>
      <requirements>
        - /onboarding 페이지 생성
        - 진행도 표시기 (1/3 → 2/3 → 3/3)
        - 뒤로가기 버튼
        - 건너뛰기 옵션
      </requirements>
    </criterion>
    <criterion id="AC2">
      <title>기본 정보 입력 (1단계)</title>
      <requirements>
        - 이름 입력 필드 (필수, 2-50자)
        - 이메일 표시 (읽기 전용)
        - 실시간 유효성 검사
        - 다음 버튼
      </requirements>
    </criterion>
    <criterion id="AC3">
      <title>프로필 소개 입력 (2단계)</title>
      <requirements>
        - 소개 텍스트 에어리어 (선택, 최대 500자)
        - 글자수 카운터
        - 다음/이전 버튼
      </requirements>
    </criterion>
    <criterion id="AC4">
      <title>프로필 사진 업로드 (3단계)</title>
      <requirements>
        - 이미지 업로드 버튼 (드래그앤드롭 지원)
        - 이미지 미리보기
        - 최대 파일 크기: 5MB
        - 지원 형식: JPG, PNG, WebP
        - 업로드 후 자동 크롭 (정사각형)
        - 이전/완료 버튼
      </requirements>
    </criterion>
    <criterion id="AC5">
      <title>프로필 저장</title>
      <requirements>
        - Supabase profiles 테이블 업데이트
        - 프로필 사진은 Supabase Storage에 저장
        - 로딩 상태 표시
        - 성공 메시지: "프로필 설정이 완료되었습니다"
      </requirements>
    </criterion>
    <criterion id="AC6">
      <title>에러 처리</title>
      <requirements>
        - 파일 크기 초과: "5MB 이하의 파일을 업로드해주세요"
        - 지원하지 않는 형식: "JPG, PNG, WebP 형식만 지원합니다"
        - 네트워크 에러: "연결 실패. 다시 시도해주세요"
        - 저장 실패: "프로필 저장에 실패했습니다"
      </requirements>
    </criterion>
    <criterion id="AC7">
      <title>사용자 경험</title>
      <requirements>
        - 모바일 반응형 디자인
        - 터치 타겟 최소 44x44px
        - 로딩 중 버튼 비활성화
        - 건너뛰기 시 /dashboard로 리다이렉트
        - 완료 시 /dashboard로 리다이렉트
      </requirements>
    </criterion>
    <criterion id="AC8">
      <title>데이터 보존</title>
      <requirements>
        - 온보딩 중 페이지 새로고침 시 입력값 유지
        - 세션 스토리지 또는 Zustand로 임시 저장
      </requirements>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/architecture.md</path>
        <title>ContentFlow AI - Technical Architecture</title>
        <section>Auth 및 Supabase 플랫폼, 프로필 데이터 모델</section>
        <snippet>Supabase Auth (OAuth, Email), PostgreSQL Database (멀티테넌트), Storage (프로필 사진 저장)</snippet>
      </doc>
      <doc>
        <path>docs/ux-design-specification.md</path>
        <title>UX Design Specification</title>
        <section>온보딩 플로우, 멀티스텝 폼 디자인, 프로필 입력 UI</section>
        <snippet>온보딩은 3단계 프로세스: 기본 정보 → 소개 → 사진. 진행도 표시기와 명확한 CTA 필수</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic 2 - 사용자 인증 및 계정 관리</title>
        <section>프로필 등록 및 온보딩 스토리</section>
        <snippet>신규 사용자의 프로필 완성 워크플로우. Story 2.1-2.4 완료 후 진행</snippet>
      </doc>
    </docs>

    <code>
      <artifact>
        <path>apps/web/src/lib/api/auth-api.ts</path>
        <kind>service</kind>
        <symbol>signUp, signOut, getUser, resetPasswordForEmail</symbol>
        <reason>기존 인증 함수들과 연계. 프로필 저장 로직 추가 필요</reason>
      </artifact>
      <artifact>
        <path>apps/web/src/app/(auth)/login/page.tsx</path>
        <kind>page</kind>
        <symbol>LoginPage</symbol>
        <reason>온보딩 후 대시보드로 리다이렉트 패턴 참고</reason>
      </artifact>
      <artifact>
        <path>apps/web/src/middleware.ts</path>
        <kind>middleware</kind>
        <symbol>middleware, config</symbol>
        <lines>4-6</lines>
        <reason>/onboarding 라우트 보호 설정. 인증된 사용자만 접근</reason>
      </artifact>
      <artifact>
        <path>apps/web/src/stores</path>
        <kind>directory</kind>
        <reason>Zustand 스토어 위치. authStore 참고하여 onboardingStore 생성</reason>
      </artifact>
      <artifact>
        <path>apps/web/src/components</path>
        <kind>directory</kind>
        <reason>컴포넌트 구조: auth/, onboarding/, profile/ 폴더 생성</reason>
      </artifact>
    </code>

    <dependencies>
      <ecosystem name="node">
        <package name="react-hook-form" version="^7.x">폼 검증 및 상태 관리</package>
        <package name="zod" version="^3.x">스키마 검증</package>
        <package name="zustand" version="^4.x">상태 관리</package>
        <package name="@supabase/supabase-js" version="^2.x">Supabase 클라이언트</package>
        <package name="next" version="^15.x">Next.js 15 프레임워크</package>
        <package name="typescript" version="^5.x">TypeScript</package>
        <package name="tailwindcss" version="^3.x">스타일링</package>
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>
      <type>pattern</type>
      <description>React Hook Form + Zod 검증 패턴 필수. 다른 폼 라이브러리 사용 금지</description>
    </constraint>
    <constraint>
      <type>pattern</type>
      <description>Zustand를 사용하여 온보딩 상태 관리 (폼 데이터 임시 저장)</description>
    </constraint>
    <constraint>
      <type>naming</type>
      <description>컴포넌트: OnboardingStep[1-3].tsx, ProgressIndicator.tsx, 스토어: onboardingStore.ts</description>
    </constraint>
    <constraint>
      <type>routing</type>
      <description>경로: /onboarding (메인), /onboarding/complete (완료), /dashboard (리다이렉트)</description>
    </constraint>
    <constraint>
      <type>security</type>
      <description>모든 프로필 업로드는 인증된 사용자만. Middleware에서 /onboarding 보호</description>
    </constraint>
    <constraint>
      <type>database</type>
      <description>profiles 테이블: full_name, bio, avatar_url, updated_at 컬럼 활용</description>
    </constraint>
    <constraint>
      <type>storage</type>
      <description>Supabase Storage 경로: avatars/{userId}/{timestamp}.{ext}, 이미지 최적화 (WebP)</description>
    </constraint>
    <constraint>
      <type>ui</type>
      <description>Shadcn/ui 컴포넌트 활용. 모바일 반응형 필수 (44x44px 터치 타겟)</description>
    </constraint>
    <constraint>
      <type>testing</type>
      <description>유닛 테스트(Vitest), 통합 테스트, E2E 테스트 필수</description>
    </constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>updateProfile API</name>
      <kind>function</kind>
      <signature>async function updateProfile(data: { full_name: string; bio: string; avatar_url?: string }): Promise&lt;Profile&gt;</signature>
      <path>apps/web/src/lib/api/profile-api.ts</path>
    </interface>
    <interface>
      <name>uploadProfileAvatar API</name>
      <kind>function</kind>
      <signature>async function uploadProfileAvatar(file: File): Promise&lt;string&gt; // 반환: avatar_url</signature>
      <path>apps/web/src/lib/api/profile-api.ts</path>
    </interface>
    <interface>
      <name>OnboardingStep Component</name>
      <kind>React Component</kind>
      <signature>interface OnboardingStepProps { step: 1|2|3; onNext: () => void; onPrev?: () => void; }</signature>
      <path>apps/web/src/components/onboarding/OnboardingStep[1-3].tsx</path>
    </interface>
    <interface>
      <name>onboardingStore</name>
      <kind>Zustand Store</kind>
      <signature>{ fullName, bio, avatarFile, currentStep, setFullName(), setBio(), setAvatarFile(), setStep(), reset() }</signature>
      <path>apps/web/src/stores/onboardingStore.ts</path>
    </interface>
    <interface>
      <name>Middleware Protection</name>
      <kind>Next.js Middleware</kind>
      <signature>/onboarding 라우트는 인증 필수. 미인증 사용자는 /login으로 리다이렉트</signature>
      <path>apps/web/src/middleware.ts</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Vitest를 사용한 유닛 테스트, React Testing Library를 사용한 컴포넌트 테스트, Supabase Storage 모킹.
      모든 폼 검증, 파일 업로드, API 호출에 대한 테스트 필수.
      E2E 테스트는 전체 온보딩 플로우(3단계 완료 → 대시보드 리다이렉트) 검증.
    </standards>
    <locations>
      apps/web/src/__tests__/onboarding.test.ts
      apps/web/src/components/onboarding/__tests__/
      apps/web/src/lib/utils/__tests__/image.test.ts
    </locations>
    <ideas>
      AC1: 온보딩 페이지 렌더링 및 진행도 표시기 확인
      AC2: 이름 필드 유효성 검사 (2-50자)
      AC3: 소개 글자수 카운터 (0-500자)
      AC4: 파일 업로드 검증 (5MB, JPG/PNG/WebP)
      AC5: 프로필 저장 및 Supabase 업데이트 확인
      AC6: 에러 메시지 출력 확인
      AC7: 모바일 반응형 검증
      AC8: 페이지 새로고침 후 데이터 유지 확인
    </ideas>
  </tests>

</story-context>
