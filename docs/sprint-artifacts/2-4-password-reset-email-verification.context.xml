<?xml version="1.0" encoding="UTF-8"?>
<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>2.4</storyId>
    <title>비밀번호 재설정 및 이메일 인증</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-15</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/2-4-password-reset-email-verification.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>비밀번호를 잊어버린 사용자</asA>
    <iWant>이메일로 비밀번호를 재설정할 수 있어</iWant>
    <soThat>계정에 다시 접근할 수 있다</soThat>
    <tasks>
      - Task 1: 비밀번호 찾기 페이지 UI 개발 (/forgot-password)
      - Task 2: ForgotPasswordForm 컴포넌트 개발
      - Task 3: 비밀번호 재설정 페이지 UI 개발 (/reset-password)
      - Task 4: ResetPasswordForm 컴포넌트 개발
      - Task 5: 비밀번호 재설정 API 함수 구현 (auth-api.ts)
      - Task 6: 토큰 검증 및 처리
      - Task 7: 에러 처리 및 사용자 피드백
      - Task 8: 이메일 템플릿 설정
      - Task 9: 테스트 코드 작성
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC1">
      <title>비밀번호 찾기 페이지</title>
      <items>
        - /forgot-password 페이지 생성
        - 이메일 입력 필드
        - "재설정 링크 발송" 버튼
        - 성공 메시지: "이메일 주소를 확인해주세요"
        - 보안: 존재하지 않는 이메일도 동일한 응답
      </items>
    </criterion>
    <criterion id="AC2">
      <title>비밀번호 재설정 페이지</title>
      <items>
        - /reset-password 페이지 (쿼리 파라미터: token)
        - 새 비밀번호 입력 필드
        - 비밀번호 확인 입력 필드
        - 비밀번호 강도 표시기
        - "비밀번호 변경" 버튼
      </items>
    </criterion>
    <criterion id="AC3">
      <title>이메일 발송</title>
      <items>
        - Supabase resetPasswordForEmail() 호출
        - 이메일 발송 (Supabase 내장 또는 자체 Mailpit)
        - 유효시간: 1시간
        - 이메일 템플릿에 재설정 링크 포함
      </items>
    </criterion>
    <criterion id="AC4">
      <title>토큰 검증</title>
      <items>
        - URL에서 토큰 추출 및 검증
        - 유효하지 않은 토큰: 오류 메시지 표시
        - 만료된 토큰: "링크가 만료되었습니다" 메시지
        - 토큰 재발송 옵션 제공
      </items>
    </criterion>
    <criterion id="AC5">
      <title>비밀번호 변경</title>
      <items>
        - Supabase updateUser() 호출
        - 비밀번호 정책: 8자 이상, 대문자, 숫자, 특수문자
        - 변경 성공 시 /login으로 리다이렉트
        - 성공 메시지: "비밀번호가 변경되었습니다"
      </items>
    </criterion>
    <criterion id="AC6">
      <title>에러 처리</title>
      <items>
        - 네트워크 에러: "연결 실패. 다시 시도해주세요"
        - 서버 에러: "오류가 발생했습니다"
        - 한글 오류 메시지
      </items>
    </criterion>
    <criterion id="AC7">
      <title>사용자 경험</title>
      <items>
        - 실시간 폼 유효성 검사 피드백
        - 로딩 상태 표시 (제출 중)
        - 모바일 반응형 (44x44px 터치 타겟)
        - 스킵/뒤로가기 옵션
      </items>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-2.md</path>
        <title>Epic 2: 사용자 인증 및 계정 관리 - 기술 사양</title>
        <section>Story 2.4: 비밀번호 재설정 (이메일 인증)</section>
        <snippet>Backend: Supabase `resetPasswordForEmail()`, `updateUser()`. Email: Supabase 내장 이메일 서비스. Token: 임시 토큰 (Supabase 관리).</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/2-1-supabase-auth-integration-email-password.md</path>
        <title>Story 2.1: Supabase Auth 통합</title>
        <section>완료된 이메일/비밀번호 인증 기반</section>
        <snippet>Supabase Auth 통합 및 비밀번호 정책 설정이 완료됨. 이 스토리는 로그인한 사용자의 비밀번호 재설정을 구현.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/2-3-login-page-and-session-management.md</path>
        <title>Story 2.3: 로그인 페이지 및 세션 관리</title>
        <section>완료된 로그인 페이지</section>
        <snippet>로그인 페이지에서 "비밀번호를 잊으셨나요?" 링크가 /forgot-password로 연결.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>apps/web/src/lib/api/auth-api.ts</path>
        <kind>service</kind>
        <symbol>signIn, signUp, signInWithGoogle</symbol>
        <lines>1-200</lines>
        <reason>기존 Supabase 인증 API. resetPasswordForEmail() 및 updatePassword() 함수 추가 필요</reason>
      </artifact>
      <artifact>
        <path>apps/web/src/lib/schemas/auth.schema.ts</path>
        <kind>schema</kind>
        <symbol>signInSchema, signUpSchema, PasswordStrengthMeter</symbol>
        <lines>1-100</lines>
        <reason>Zod 비밀번호 검증 스키마. ResetPasswordSchema 추가 필요</reason>
      </artifact>
      <artifact>
        <path>apps/web/src/components/auth/PasswordStrengthMeter.tsx</path>
        <kind>component</kind>
        <symbol>PasswordStrengthMeter</symbol>
        <lines>1-100</lines>
        <reason>비밀번호 강도 표시 컴포넌트. Story 2.1에서 구현됨. 재사용 필요</reason>
      </artifact>
      <artifact>
        <path>apps/web/src/components/auth/LogInForm.tsx</path>
        <kind>component</kind>
        <symbol>LogInForm</symbol>
        <lines>1-200</lines>
        <reason>완료된 로그인 폼. ForgotPasswordForm 및 ResetPasswordForm의 참고 자료</reason>
      </artifact>
      <artifact>
        <path>apps/web/src/middleware.ts</path>
        <kind>middleware</kind>
        <symbol>middleware</symbol>
        <lines>1-70</lines>
        <reason>Route 보호 미들웨어. /forgot-password, /reset-password는 공개 라우트로 추가</reason>
      </artifact>
    </code>
    <dependencies>
      <framework name="Next.js">
        <version>15.0.3</version>
        <reason>App Router, SSR, Middleware support</reason>
      </framework>
      <package name="@supabase/supabase-js">
        <version>^2.81.1</version>
        <reason>resetPasswordForEmail(), updateUser() API</reason>
      </package>
      <package name="react-hook-form">
        <version>^7.66.0</version>
        <reason>Form state management and validation</reason>
      </package>
      <package name="zod">
        <version>^4.1.12</version>
        <reason>Schema validation for password reset forms</reason>
      </package>
      <package name="zustand">
        <version>^5.0.8</version>
        <reason>State management (already used in authStore)</reason>
      </package>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>
      <title>이메일 보안</title>
      <description>존재하지 않는 이메일 주소에도 동일한 "이메일을 확인해주세요" 응답 반환. 보안상 이유로 실패 여부 노출 금지</description>
    </constraint>
    <constraint>
      <title>토큰 유효시간</title>
      <description>Supabase 기본값: 1시간. 이 시간 내에 비밀번호 재설정 완료 필요</description>
    </constraint>
    <constraint>
      <title>비밀번호 정책</title>
      <description>최소 8자, 대문자 포함, 숫자 포함, 특수문자 포함. Story 2.1에서 정의된 정책 일관성 유지</description>
    </constraint>
    <constraint>
      <title>한글 지역화</title>
      <description>모든 에러 메시지, 성공 메시지, UI 레이블은 한글로 제공</description>
    </constraint>
    <constraint>
      <title>URL 파라미터</title>
      <description>/reset-password?token=xxx 형식. URL에 토큰 포함 필수</description>
    </constraint>
    <constraint>
      <title>라우트 보호</title>
      <description>/forgot-password, /reset-password는 미들웨어의 publicAuthRoutes에 추가되어야 함</description>
    </constraint>
    <constraint>
      <title>리다이렉트</title>
      <description>성공 시 /login으로 리다이렉트. 실패 시 현재 페이지 유지</description>
    </constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>resetPasswordForEmail</name>
      <kind>Supabase Auth Method</kind>
      <signature>async resetPasswordForEmail(email: string): Promise&lt;AuthResponse&gt;</signature>
      <path>@supabase/supabase-js</path>
      <note>이메일로 비밀번호 재설정 링크 발송</note>
    </interface>
    <interface>
      <name>updateUser</name>
      <kind>Supabase Auth Method</kind>
      <signature>async updateUser(attributes: { password: string }): Promise&lt;User&gt;</signature>
      <path>@supabase/supabase-js</path>
      <note>새로운 비밀번호로 사용자 정보 업데이트</note>
    </interface>
    <interface>
      <name>GET /forgot-password</name>
      <kind>Page</kind>
      <signature>ForgotPasswordPage()</signature>
      <path>apps/web/src/app/(auth)/forgot-password/page.tsx</path>
      <note>비밀번호 찾기 페이지</note>
    </interface>
    <interface>
      <name>GET /reset-password?token=xxx</name>
      <kind>Page</kind>
      <signature>ResetPasswordPage(props: { searchParams: { token: string } })</signature>
      <path>apps/web/src/app/(auth)/reset-password/page.tsx</path>
      <note>비밀번호 재설정 페이지</note>
    </interface>
    <interface>
      <name>resetPassword</name>
      <kind>API Function</kind>
      <signature>async resetPassword(email: string): Promise&lt;{ success: boolean; error: AuthError | null }&gt;</signature>
      <path>apps/web/src/lib/api/auth-api.ts</path>
      <note>ForgotPasswordForm에서 호출</note>
    </interface>
    <interface>
      <name>updatePassword</name>
      <kind>API Function</kind>
      <signature>async updatePassword(newPassword: string): Promise&lt;{ success: boolean; error: AuthError | null }&gt;</signature>
      <path>apps/web/src/lib/api/auth-api.ts</path>
      <note>ResetPasswordForm에서 호출. URL 토큰 자동 사용</note>
    </interface>
  </interfaces>

  <tests>
    <standards>
      테스트는 Vitest를 사용하여 `apps/web/src/__tests__/` 디렉토리에 작성됨.
      각 폼 컴포넌트마다 유닛 테스트 작성.
      Supabase API 호출은 Mock하여 테스트.
      유효성 검사 (Schema + Form validation) 테스트 포함.
    </standards>
    <locations>
      - apps/web/src/__tests__/password-reset.test.ts (메인 테스트 파일)
      - Story 2.1, 2.3의 기존 테스트 구조 참고
    </locations>
    <ideas>
      - AC1: ForgotPasswordForm 렌더링 및 이메일 입력 유효성 검사
      - AC2: ResetPasswordForm 렌더링, 새 비밀번호 입력 및 강도 표시
      - AC3: resetPassword() 함수 호출 및 성공 응답 처리
      - AC4: 유효하지 않은/만료된 토큰 처리 및 오류 메시지 표시
      - AC5: updatePassword() 함수 호출 및 /login 리다이렉트
      - AC6: 네트워크 에러 및 서버 에러 처리
      - AC7: 모바일 반응형 디자인 (터치 타겟 크기)
    </ideas>
  </tests>
</story-context>
