<?xml version="1.0" encoding="UTF-8"?>
<story-context id="story-2.6-context" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>2.6</storyId>
    <title>프로필 편집 페이지</title>
    <storyKey>2-6-profile-edit-page</storyKey>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-15</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/2-6-profile-edit-page.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>등록된 사용자</asA>
    <iWant>프로필 정보(이름, 소개, 프로필사진)를 수정할 수 있어</iWant>
    <soThat>내 정보를 항상 최신으로 유지할 수 있다</soThat>
    <tasks>
      <task n="1">프로필 페이지 생성 (/profile/page.tsx)</task>
      <task n="2">프로필 편집 페이지 생성 (/profile/edit/page.tsx)</task>
      <task n="3">프로필 편집 폼 컴포넌트 (ProfileEditForm.tsx)</task>
      <task n="4">프로필 이미지 업로드 컴포넌트 (ProfileImageUpload.tsx)</task>
      <task n="5">프로필 API 함수 확장 (lib/api/profile-api.ts)</task>
      <task n="6">프로필 상태 관리 (profileStore.ts)</task>
      <task n="7">이미지 최적화 유틸리티 (lib/utils/image.ts)</task>
      <task n="8">미들웨어 업데이트 (/profile, /profile/edit 보호)</task>
      <task n="9">테스트 코드 작성</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC1">
      <title>프로필 페이지</title>
      <requirements>
        - /profile 페이지 생성
        - 현재 프로필 정보 표시 (사진, 이름, 이메일, 소개)
        - 편집 버튼
        - 계정 삭제 버튼
      </requirements>
    </criterion>
    <criterion id="AC2">
      <title>프로필 편집 모달/페이지</title>
      <requirements>
        - /profile/edit 페이지 또는 모달
        - 수정 가능한 필드: 이름(필수, 2-50자), 소개(선택, 500자), 프로필 사진(선택)
        - 현재 값 pre-fill
        - 실시간 유효성 검사
      </requirements>
    </criterion>
    <criterion id="AC3">
      <title>필드별 편집</title>
      <requirements>
        - 이름 필드: 텍스트 입력, 유효성 검사, 변경 감지
        - 소개 필드: 텍스트 에어리어, 글자수 카운터, 변경 감지
        - 프로필 사진: 현재 사진 표시, 업로드 버튼, 미리보기, 제거 버튼, 파일 검증(크기, 형식)
      </requirements>
    </criterion>
    <criterion id="AC4">
      <title>저장 기능</title>
      <requirements>
        - 변경사항이 없으면 저장 버튼 비활성화
        - 저장 시 로딩 표시
        - Supabase profiles 테이블 업데이트
        - 성공 메시지: "프로필이 수정되었습니다"
        - 저장 후 프로필 페이지로 리다이렉트
      </requirements>
    </criterion>
    <criterion id="AC5">
      <title>이미지 업로드</title>
      <requirements>
        - 프로필 사진 변경 시 새 이미지 업로드
        - Supabase Storage에 저장
        - 기존 이미지 삭제
        - 이미지 최적화 (WebP 변환)
      </requirements>
    </criterion>
    <criterion id="AC6">
      <title>에러 처리</title>
      <requirements>
        - 파일 크기 초과: "5MB 이하의 파일을 업로드해주세요"
        - 지원하지 않는 형식: "JPG, PNG, WebP 형식만 지원합니다"
        - 유효성 검사 오류 표시
        - 네트워크 에러: "연결 실패. 다시 시도해주세요"
        - 저장 실패: "프로필 수정에 실패했습니다"
      </requirements>
    </criterion>
    <criterion id="AC7">
      <title>사용자 경험</title>
      <requirements>
        - 모바일 반응형 디자인
        - 변경사항 있을 때만 저장 버튼 활성화
        - 취소 버튼
        - 뒤로가기 시 확인 메시지 (변경사항이 있을 경우)
      </requirements>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/architecture.md</path>
        <title>ContentFlow AI - Technical Architecture</title>
        <section>프로필 데이터 모델, Supabase Storage</section>
        <snippet>profiles 테이블: full_name, bio, avatar_url, updated_at. Supabase Storage: avatars/{userId}/{timestamp}.{ext}</snippet>
      </doc>
      <doc>
        <path>docs/ux-design-specification.md</path>
        <title>UX Design Specification</title>
        <section>프로필 페이지, 편집 UI 디자인</section>
        <snippet>프로필 페이지는 사용자 정보 표시 + 편집/삭제 액션. 편집 페이지는 인라인 폼 또는 모달</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/2-5-profile-registration-onboarding.md</path>
        <title>Story 2.5 - 프로필 등록 및 온보딩</title>
        <section>온보딩 완료 후 프로필 편집 기능</section>
        <snippet>Story 2.5의 온보딩 단계에서 입력한 프로필 데이터를 편집하는 기능. API 함수 재사용 가능</snippet>
      </doc>
    </docs>

    <code>
      <artifact>
        <path>apps/web/src/lib/api/auth-api.ts</path>
        <kind>service</kind>
        <symbol>getUser, updateProfile</symbol>
        <reason>기존 프로필 조회 및 업데이트 함수. 확장하여 전체 프로필 정보 반환</reason>
      </artifact>
      <artifact>
        <path>apps/web/src/stores</path>
        <kind>directory</kind>
        <reason>Zustand 스토어 구조. profileStore.ts 생성 (프로필 정보, 로딩, 에러 상태)</reason>
      </artifact>
      <artifact>
        <path>apps/web/src/components/auth</path>
        <kind>directory</kind>
        <reason>기존 폼 컴포넌트 구조 참고. ProfileEditForm, ProfileImageUpload 생성</reason>
      </artifact>
      <artifact>
        <path>apps/web/src/app/(auth)/login/page.tsx</path>
        <kind>page</kind>
        <symbol>LoginPage</symbol>
        <reason>라우트 구조 패턴 참고. (auth) 그룹 내에서 /profile 페이지 생성</reason>
      </artifact>
      <artifact>
        <path>apps/web/src/middleware.ts</path>
        <kind>middleware</kind>
        <symbol>protectedRoutes</symbol>
        <lines>4-5</lines>
        <reason>/profile, /profile/edit 라우트 보호 설정 확인</reason>
      </artifact>
    </code>

    <dependencies>
      <ecosystem name="node">
        <package name="react-hook-form" version="^7.x">폼 검증 및 변경 감지</package>
        <package name="zod" version="^3.x">스키마 검증</package>
        <package name="zustand" version="^4.x">프로필 상태 관리</package>
        <package name="@supabase/supabase-js" version="^2.x">Supabase 클라이언트</package>
        <package name="next" version="^15.x">Next.js 15 라우팅</package>
        <package name="typescript" version="^5.x">TypeScript</package>
        <package name="tailwindcss" version="^3.x">스타일링</package>
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>
      <type>pattern</type>
      <description>React Hook Form + Zod 검증 필수. isDirty 플래그로 저장 버튼 활성화/비활성화</description>
    </constraint>
    <constraint>
      <type>pattern</type>
      <description>변경사항 감지: React Hook Form의 formState.isDirty 활용</description>
    </constraint>
    <constraint>
      <type>naming</type>
      <description>컴포넌트: ProfileEditForm.tsx, ProfileImageUpload.tsx, ProfileDisplay.tsx</description>
    </constraint>
    <constraint>
      <type>routing</type>
      <description>경로: /profile (표시), /profile/edit (편집). 모두 인증 필수</description>
    </constraint>
    <constraint>
      <type>security</type>
      <description>프로필 수정은 소유자만 가능. RLS 정책 활용</description>
    </constraint>
    <constraint>
      <type>storage</type>
      <description>기존 이미지 삭제 필수. Supabase Storage에서 old avatar_url 제거</description>
    </constraint>
    <constraint>
      <type>ui</type>
      <description>Shadcn/ui 컴포넌트 사용. 모바일 반응형 필수</description>
    </constraint>
    <constraint>
      <type>form</type>
      <description>뒤로가기 시 변경사항 확인: isDirty && confirm() 패턴</description>
    </constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>getProfile API</name>
      <kind>function</kind>
      <signature>async function getProfile(): Promise&lt;Profile&gt;</signature>
      <path>apps/web/src/lib/api/profile-api.ts</path>
    </interface>
    <interface>
      <name>updateProfile API</name>
      <kind>function</kind>
      <signature>async function updateProfile(data: { full_name: string; bio: string; avatar_url?: string }): Promise&lt;Profile&gt;</signature>
      <path>apps/web/src/lib/api/profile-api.ts</path>
    </interface>
    <interface>
      <name>deleteProfileImage API</name>
      <kind>function</kind>
      <signature>async function deleteProfileImage(avatarUrl: string): Promise&lt;void&gt;</signature>
      <path>apps/web/src/lib/api/profile-api.ts</path>
    </interface>
    <interface>
      <name>ProfileEditForm Component</name>
      <kind>React Component</kind>
      <signature>interface ProfileEditFormProps { onSuccess: () => void; onCancel: () => void; }</signature>
      <path>apps/web/src/components/profile/ProfileEditForm.tsx</path>
    </interface>
    <interface>
      <name>ProfileImageUpload Component</name>
      <kind>React Component</kind>
      <signature>interface ProfileImageUploadProps { currentImage?: string; onChange: (file: File | null) => void; }</signature>
      <path>apps/web/src/components/profile/ProfileImageUpload.tsx</path>
    </interface>
    <interface>
      <name>profileStore</name>
      <kind>Zustand Store</kind>
      <signature>{ profile, loading, error, fetchProfile(), updateProfile(), setError() }</signature>
      <path>apps/web/src/stores/profileStore.ts</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Vitest 유닛 테스트, React Testing Library 컴포넌트 테스트.
      모든 검증 규칙, 변경 감지, 이미지 업로드, API 호출 테스트.
      E2E 테스트: 프로필 편집 전체 플로우 (조회 → 수정 → 저장 → 확인).
    </standards>
    <locations>
      apps/web/src/__tests__/profile.test.ts
      apps/web/src/components/profile/__tests__/
      apps/web/src/stores/__tests__/profileStore.test.ts
    </locations>
    <ideas>
      AC1: 프로필 페이지 렌더링 및 정보 표시
      AC2: 편집 폼 로드 및 현재 값 pre-fill
      AC3: 각 필드 유효성 검사 (이름 2-50자, 소개 500자)
      AC4: 변경사항 감지 및 저장 버튼 활성화
      AC5: 이미지 업로드 및 기존 파일 삭제
      AC6: 에러 메시지 표시
      AC7: 모바일 반응형, 취소 및 뒤로가기 확인
    </ideas>
  </tests>

</story-context>
